# Archives
* [Scripts for creating and importing the relational database and its tables](https://www.lampada.uerj.br/wp-content/uploads/2023/12/DataBaseScripts.zip)
* [Database Mapping for Archetypes](https://www.lampada.uerj.br/wp-content/uploads/2023/12/mapeamentoDatasusOpenEHR.ods)
* [Archetypes and Templates](https://www.lampada.uerj.br/wp-content/uploads/2023/12/archetypes_and_templates.zip)
* Database
    * [Part0](https://www.lampada.uerj.br/arquivosdb/part0.zip)
    * [Part1](https://www.lampada.uerj.br/arquivosdb/part1.zip)
    * [Part2](https://www.lampada.uerj.br/arquivosdb/part2.zip)
    * [Part3](https://www.lampada.uerj.br/arquivosdb/part3.zip)
    * [Part4](https://www.lampada.uerj.br/arquivosdb/part4.zip)
    * [Part5](https://www.lampada.uerj.br/arquivosdb/part5.zip)
    * [This repository](https://github.com/parveen-rx/sus-openehr-builder)

# Instructions for Installing the Database

1) Install Postgresql version 8.4.13 or higher.

2) Run the database creation script. The example below shows the command to run the script as a postgres user. Modify the LC_COLLATE and LC_CTYPE variables of the script according to your location.
   psql -U postgres -f orbdaCreateDB.sql

3) Run the script to create the tables of the ORBDA database:
   psql -U postgres -d orbda -f orbdaCreateTables.sql

4) Load the data into the database. Adapt the script to the dataset that was downloaded:
   psql -U postgres -d orbda -f importingFiles.sql


# Instructions for Running the Conversion Program for openEHR

The input data must be stored in a relational database. In addition, a file with the patient ids is also used as input.

The patient ids for the full database are in two files:

1) [apac_cnspcn.txt for outpatients](https://www.lampada.uerj.br/arquivosdb/apac_cnspcn.txt.zip)
2) [Inpatient aih_n_aih.txt](https://www.lampada.uerj.br/arquivosdb/aih_n_aih.txt.zip)

For subsets of the database, two files with patient ids must be generated by extracting the respective subsets from the provided id files.

The parameters for connecting to the database must be configured in the builder.properties file.

Extract the file terminology.tar.gz in "project-dir/repository/terminologies".

#### Syntax:

The syntax of the converter is as follows:

`java -Xmx8g -Dfile.encoding=UTF-8 -cp projectdir/bin/uber-sus-openehr-builder-1.0.1-SNAPSHOT.jar br.uerj.lampada.openehr.susbuilder.EHRGenerator --patients patientids --ehr-dir outputdir --type < ehr|version|composition > --format < json|xml > [--aih]`

The program converts the data from a relational database to the openEHR format and requires at least 8 Gbytes of RAM to run.

### Options:

`–patients patientids`
The patient id file to be used in the conversion.

`–ehr-dir outputdir`
The output files are generated in the directories "ehr", "ehrAccess", "ehrStatus", "contribution" and "composition" below the outputdir.

`–format < json|xml >`
Specifies the output format. It can be json or xml.

`–type < ehr|version|composition >`
Specifies the type of output. It can be ehr, version or composition.

`–Aih`
The –aih argument is used when converting inpatient data. This argument should be omitted in the case of the conversion of outpatient data.

### Examples:

In the project directory, use one of the following commands:

#### For ambulatory data conversion:

`java -Xmx8g -Dfile.encoding=UTF-8 -cp bin/uber-sus-openehr-builder-1.0.1-SNAPSHOT.jar br.uerj.lampada.openehr.susbuilder.EHRGenerator –type ehr –format xml –patients ./patientIds/apac_cnspcn.txt –ehr-dir ./ehr`

#### For inpatient data conversion:

`java -Xmx8g -Dfile.encoding=UTF-8 -cp bin/uber-sus-openehr-builder-1.0.1-SNAPSHOT.jar br.uerj.lampada.openehr.susbuilder.EHRGenerator –aih –type ehr –format xml –patients ./patientIds/aih_n_aih.txt –ehr-dir ./ehr`

Another way to perform the conversion is to use the run_jobs.sh script that generates a job in parallel for each identifier file within the patient_dir directory.

#### Syntax:

`run_jobs.sh -< composition|version|ehr > -< json|xml > -< aih|apac > patient_dir output_dir`

#### Example:

`./run_jobs.sh -composition -json -aih aih_dir aih_comp_output_dir`
